%! Author = Jander Moreira
%! Date = 10/10/2025
%! Package = ppc-ufscar

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% APRESENTAÇÃO DE INFORMAÇÕES

\RequirePackage{titlesec}
\RequirePackage{booktabs}
\RequirePackage{array}
\RequirePackage{float}
\RequirePackage{etoolbox}
\RequirePackage{multirow}
\RequirePackage{ragged2e}
\RequirePackage{tcolorbox}
\RequirePackage{cleveref}

% Quadros
\ifdef{\thechapter}{
    \newfloat{quadro}{H}{loq}[chapter]
}{
    \newfloat{quadro}{H}{loq}
}
\floatname{quadro}{Quadro}
\AtBeginEnvironment{quadro}{
    \setlength{\abovecaptionskip}{10pt}
    \setlength{\belowcaptionskip}{10pt}
}

% Referências cruzadas
\crefname{quadro}{quadro}{quadros}
\Crefname{quadro}{Quadro}{Quadros}
\crefname{table}{tabela}{tabelas}
\Crefname{table}{Tabela}{Tabelas}
\crefname{figure}{figura}{figuras}
\Crefname{figure}{Figura}{Figuras}
\crefname{section}{seção}{seções}
\Crefname{section}{Seção}{Seções}


% PPCCapa: gera a página de capa
\NewDocumentCommand{\PPCCapa}{}{
    \pagestyle{empty}
    \begin{center}
        \large\textsc{\PPCInfo{instituição}}\par
        \textsc{\PPCInfo{centro}}\par
        \vfill
        \begin{minipage}{0.8\linewidth}
            \begin{center}
                \LARGE\textsc{\textbf{\PPCInfo{curso}}}
            \end{center}
        \end{minipage}\par
        \bigskip
        \large\textbf{---~~Projeto Pedagógico de Curso~~---}\par
        \vfill
        \vspace*{10em}\PPCInfo{local}\par
        \PPCInfo{ano}
    \end{center}
    \clearpage
    \setcounter{page}{0}
}

% PPCDadosInstitucionais: gera a apresentação da instituição,
%   suas unidades e pessoas
\NewDocumentCommand{\PPCDadosInstitucionais}{}{
    \pagestyle{empty}
    \begingroup
    \singlespacing
    \begin{center}
        \ATListForEach{dados-institucionais}{\Item}{\Item\par}
    \end{center}
    \endgroup
    \clearpage
    \setcounter{page}{1}
    \ATListCreate{dados-institucionais}  % limpa para salvar memória
}

% PPCFichaDescritiva: apresenta a ficha descritiva
\NewDocumentCommand{\PPCFichaDescritiva}{}{
    \pagestyle{empty}
    \begingroup
    \begin{center}
        \large
        \textbf{Ficha Descritiva do Curso}
    \end{center}
    \vspace{3em}
    \begin{center}
        \ATListForEach{itens-ficha-descritiva}{\Item}{%
            \noindent
            \parbox[t]{0.4\linewidth}{%
                \raggedleft
                \ATAttributeIfExist[curso]{texto \Item}{
                    \textbf{\PPCInfo{texto \Item}:}%
                }{\textcolor{red}{\textbf{Texto não definido}}:}
            }%
            \hspace{0.02\linewidth}%
            \parbox[t]{0.5\linewidth}{\PPCInfo{\Item}}%
            \par
        }
    \end{center}
    \endgroup
    \clearpage
    \setcounter{page}{1}
    \ATListCreate{dados-institucionais}  % salva memória
}

% PPCFichaDisciplina: apresenta a descrição da disciplina
% #1: id da disciplina
\tcbset{
    ficha disciplina/.style = {
        sharp corners,
        coltitle = .,
        colbacktitle = white,
        colback = white,
        boxrule = 0.4pt,
        left = 0pt,
        right = 0pt,
    }
}
\NewDocumentCommand{\PPCFichaDisciplina}{ m }{
    \begingroup
    \singlespacing
    \noindent
    \begin{tcolorbox}[
        ficha disciplina,
        title = {\textbf{\PPCDisciplina{#1}{nome}}}\hfill\large\texttt{\PPCDisciplina{#1}{código}}
    ]
        \begin{tabular}{>{\bfseries\raggedright}p{0.25\linewidth}p{0.70\linewidth}}
            Caráter:                   & \ATAttributeIfExist[#1]{caráter}{\PPCDisciplina{#1}{caráter}}{\textit{Indefinido}}                   \\
            \hline
            Objetivo:                  & \PPCDisciplina{#1}{objetivo}                  \\
            \hline
            Ementa:                    & \PPCDisciplina{#1}{ementa}                    \\
            \hline
            Carga horária: &
            \ATForEach{\TipoHora}{teóricas, práticas, extensionistas, estágio}[{ e }{, }{ e }{}]{\TipoHora:~\PPCDisciplina{#1}{horas \TipoHora}h} \\
            \hline
            Departamento responsável:  & \PPCDisciplina{#1}{departamento}              \\
            \hline
            Pré-requisitos: &
            \ATListForEach{#1-pré-requisitos}{\prereq}[{ e }{ e }{, }{}]{%
                \ATAttributeIfExist[#1]{código}{\PPCDisciplina{#1}{código}--}{}%
                \ATAttributeIfExist[#1]{nome abreviado}{\PPCDisciplina{#1}{nome abrevidado}}{\PPCDisciplina{\prereq}{nome}}%
            }
            \\
            \hline
            Bibliografia básica:       & \PPCDisciplina{#1}{bibliografia básica}       \\
            \hline
            Bibliografia complementar: & \PPCDisciplina{#1}{bibliografia complementar} \\
            \hline
            Competências:              & \PPCDisciplina{#1}{competências}              \\
        \end{tabular}
    \end{tcolorbox}
    \endgroup
}

% ppc@ApresenteTabelaPeriodo: apresenta a tabela para um período específico
% #1: (opcional) nome da matriz
% #2: número do período
\newcounter{ppc@NumeroItem}
\NewDocumentCommand{\ppc@ConteudoTabelaPeriodo}{}{}
\NewDocumentCommand{\ppc@ApresenteTabelaPeriodo}{ O{matriz-principal} m m } {%
    \csdef{ppc@ConteudoTabelaPeriodo}{}%
    \defcounter{ppc@NumeroItem}{0}%
    \ATListForEach{#1-periodo-#2}{\codigo}{%
        \stepcounter{ppc@NumeroItem}%
        \xappto{\ppc@ConteudoTabelaPeriodo}{%
            \theppc@NumeroItem &
            \PPCDisciplina{\codigo}{nome} &
            \PPCDisciplina{\codigo}{pré-requisitos} &
            \PPCDisciplina{\codigo}{departamento} &
            \PPCDisciplina{\codigo}{caráter} &
            \PPCDisciplina{\codigo}{horas práticas} &
            \PPCDisciplina{\codigo}{horas teóricas} &
            \PPCDisciplina{\codigo}{horas extensionistas} &
            \PPCDisciplina{\codigo}{horas estágio} &
            \PPCDisciplina{\codigo}{horas total}
            \\
        }%
    }%
    \begin{quadro}
        \caption{#3}
        \bigskip
        \begin{tabular}{c>{\RaggedRight\arraybackslash}p{6cm}>{\RaggedRight\arraybackslash}p{5cm}ccccccc}
            \hline
            \multirow{2}{*}{\textbf{nº}} &
            \multirow{2}{*}{\textbf{Disciplina}} &
            \multirow{2}{*}{\textbf{Requisitos}} &
            \textbf{Depto.} &
            \multirow{2}{*}{\textbf{Caráter}} &
            \multicolumn{5}{c}{\textbf{Natureza (horas)}}
            \\
            % nº
            & % disciplina
            & % requisitos
            & \textbf{Ofertante}
            & % caráter
            & \textbf{T} & \textbf{P} & \textbf{Ext} & \textbf{Est} & \textbf{Total}
            \\
            \hline
            \ppc@ConteudoTabelaPeriodo%
            \hline
        \end{tabular}\par
    \end{quadro}
}

% PPCQuadroPeriodo: apresenta um quadro com as disciplinas de um ou mais períodos.
% #1: (opcional) nome da matriz
% #2: lista separada por vírgula dos períodos (se vazia, todos)
\NewDocumentCommand{\PPCQuadroPeriodo}{ O{matriz-principal} > { \TrimSpaces } m o } {%
    \begingroup%
    \singlespacing%
    \ifstrempty{#2}{%
        \csdef{ppc@local@ListaPeriodos}{1, 2, 3, 4, 5, 6, 7, 8}%
    }{%
        \csdef{ppc@local@ListaPeriodos}{#2}%
    }%
    \IfValueTF{#3}{%
        \csdef{ppc@local@Titulo}{#3}%
    }{%
        \csdef{ppc@local@Titulo}{Disciplinas do \periodoº \ATAttributeGet[#1]{nome período}~(Carga horária de \PPCCargaHoraria{total \periodo}\,h).}%
    }%
    \ATForEachFrom{\periodo}{\ppc@local@ListaPeriodos}{%
        \ppc@ApresenteTabelaPeriodo[#1]{\periodo}{\ppc@local@Titulo}
    }%
    \endgroup%
}
