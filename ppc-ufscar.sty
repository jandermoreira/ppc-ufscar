%! Package = ppc-ufscar
%! Author = Jander Moreira (moreira.jander@gmail.com)
%! Date = 25/04/2025

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ppc-ufscar}[2025/04/25 Classe para a edição de Projetos Pedagógicos de Curso]

\@ifclassloaded{report}{}{
    \PackageWarning{ppc-ufscar}{'ppc-ufscar' foi projetado para a classe 'report'}
    \PackageWarning{ppc-ufscar}{O uso em outras classes pode causar comportamento imprevisível ou indesejável}
}

\NewDocumentCommand{\PPCVersion}{}{0.1}

%
% Pacotes
\RequirePackage{etoolbox}
\RequirePackage{attrtoolbox}
\RequirePackage{titlesec}
\RequirePackage{xcolor}
\RequirePackage{array}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DESCRIÇÃO DO CURSO

% PPCDefinaFichaDescritiva: descrição dos dados sobre o curso
% #1: lista com os atributos do curso
\ExplSyntaxOn
\cs_new:Npn \ppc_separe_texto_conteudo:n #1 {
    \seq_set_split:Nnn \l_local_argumentos_seq { } { #1 }
    \seq_pop_left:NN \l_local_argumentos_seq \l_tmpa_tl
    \ATAttributeSetFrom[curso]{texto~\l_keys_key_str}{\l_tmpa_tl}
    \seq_pop_left:NN \l_local_argumentos_seq \l_tmpa_tl
    \ATAttributeSetFrom[curso]{\l_keys_key_str}{\l_tmpa_tl}
}
\keys_define:nn { ficha-descritiva }{
    ano .code:n = { \ppc_separe_texto_conteudo:n { #1 } },
    local .code:n = { \ppc_separe_texto_conteudo:n { #1 } },
    unknown .code:n = {
        \ppc_separe_texto_conteudo:n { #1 }
        \ATListAppendItemsFrom{itens-ficha-descritiva}{\l_keys_key_str}
    },
}

\ATListCreate{itens-ficha-descritiva}
\NewDocumentCommand{\PPCDefinaFichaDescritiva}{ > { \TrimSpaces } m }{
    \keys_set:nn { ficha-descritiva } { #1 }
}

\ExplSyntaxOff

% \ppc@VerifiqueAtributosObrigatorios: verifica se os atributos mínimos estão definidos
\ATListCreate{obrigatórios-curso}
\ATListAppendItems{obrigatórios-curso}{universidade, curso, centro, ano, local}
\NewDocumentCommand{\ppc@VerifiqueAtributosObrigatorios}{}{%
    \ATListForEach{obrigatórios-curso}{\Atributo}{%
        \ATAttributeIfExist{curso}{\Atributo}{}{%
            \PackageError{ppc-ufscar}{Atributo '\Atributo' é obrigatório}.%
        }%
    }%
}

\NewDocumentCommand{\PPCInfo}{ m }{%
    \ATAttributeGet[curso]{#1}%
}

% PPCDefinaApresentacaoInstitucional: define como será a apresentação de
%   dados da instituição
% #1: lista de separada por vírgulas, na forma chave = valor
%
% As chaves podem ser:
%   unidade:
%   cargo:
%   pessoa:
%   nova página: insere uma quebra de página
\ExplSyntaxOn
\seq_new:N \l_local_argumentos_seq
\keys_define:nn { lista-descritiva } {
    unidade .code:n = {
        \ATListAppendItems{\l_local_current_list_tl}{\bigskip\textsc{\textbf{\large#1}}}
    },
    cargo .code:n = {
        \ATListAppendItems{\l_local_current_list_tl}{\medskip\textbf{\small#1}}
    },
    pessoa .code:n = {
        \ATListAppendItems{\l_local_current_list_tl}{#1}
    },
    nova~página .code:n = {
        \ATListAppendItems{\l_local_current_list_tl}{\clearpage}
    },
}
\cs_new:Npn \ppc_defina_contra_capa:n #1 {
    \tl_clear_new:N \l_local_current_list_tl
    \tl_set:Nn \l_local_current_list_tl { apresentação-institucional }
    \keys_set:nn { lista-descritiva } { #1 }
}
\NewDocumentCommand{\PPCDefinaApresentacaoInstitucional}{ > { \TrimSpaces } m }{
    \ATListCreate{apresentação-institucional}
    \ppc_defina_contra_capa:n { #1 }
}
\ExplSyntaxOff


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DESCRIÇÃO DAS DISCIPLINAS

% PPCDefinaDisciplina: define uma disciplina
% #1: nome de referência ("apelido"); e.g. es1 para Engenharia de Software 1
% #2: lista separada por vírgulas com atributos e seus valores (atributo = {valor})
\NewDocumentCommand{\PPCDefinaDisciplina}{ m >{ \TrimSpaces } m }{%
    \ATClassSet{#1}{#2}%
}

% PPCDisciplina: expande para o valor de um dado atributo de uma disciplina
% #1: nome de referência ("apelido"); e.g. es1 para Engenharia de Software 1
% #2: nome do atributo
\NewDocumentCommand{\PPCDisciplina}{ m m }{%
    \ATAttributeGet[#1]{#2}%
}

% PPCImporteDisciplinas: carrega arquivos com descrições de disciplinas
% buscando no diretório ./disciplinas
% #1: lista separada por vírgulas com os nomes dos arquivos (sem .tex)
\NewDocumentCommand{\PPCImporteDisciplinas}{ > { \TrimSpaces } m }{%
    \RenewDocumentCommand{\do}{ m }{\input{##1}}%
    \docsvlist{#1}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DESCRIÇÃO DA MATRIZ CURRICULAR

\ExplSyntaxOn
\keys_define:nn { matriz } {
    unknown .code:n = {
        \ATAttributeSet{\l_ppc_disciplina_corrente_tl}{\l_keys_key_str}{#1}
    },
}

\NewDocumentCommand{\PPCDefinaMatrizCurricular}{ O{} > { \TrimSpaces } m }{
}
\ExplSyntaxOff


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% OUTROS AJUSTES

\titleformat{\chapter}{\normalfont\bfseries\Large}{\thechapter}{1em}{\Large}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% APRESENTAÇÃO DE INFORMAÇÕES

\NewDocumentCommand{\PPCCapa}{}{
    \pagestyle{empty}
    \begin{center}
        \large\textsc{\PPCInfo{instituição}}\par
        \textsc{\PPCInfo{centro}}\par
        \vfill
        \begin{minipage}{0.8\linewidth}
            \begin{center}
                \LARGE\textsc{\textbf{\PPCInfo{curso}}}
            \end{center}
        \end{minipage}\par
        \large\textbf{---~~Projeto Pedagógico de Curso~~---}\par
        \vfill
        \vspace*{10em}\PPCInfo{local}\par
        \PPCInfo{ano}
    \end{center}
    \clearpage
    \setcounter{page}{0}
}

\NewDocumentCommand{\PPCApresentacaoInstitucional}{}{
    \pagestyle{empty}
    \begingroup
    \singlespacing
% \null\vfill
    \begin{center}
        \ATListForEach{apresentação-institucional}{\Item}{\Item\par}
    \end{center}
% \vfill\null
    \endgroup
    \clearpage
    \setcounter{page}{1}
    \ATListCreate{apresentação-institucional}  % limpa para salvar memória
}

\NewDocumentCommand{\PPCFichaDescritiva}{}{
    \pagestyle{empty}
    \begingroup
% \singlespacing
    \begin{center}
        \large
        \textbf{Ficha Descritiva do Curso}
    \end{center}
    \vspace{3em}
    \begin{center}
        \ATListForEach{itens-ficha-descritiva}{\Item}{%
            \noindent
            \parbox[t]{0.4\linewidth}{%
                \raggedleft
                \ATAttributeIfExist[curso]{texto \Item}{
                    \textbf{\PPCInfo{texto \Item}:}%
                }{\textcolor{red}{\textbf{Texto não definido}}:}
            }%
            \hspace{0.02\linewidth}%
            \parbox[t]{0.5\linewidth}{\PPCInfo{\Item}}%
            \par
        }
    \end{center}
    \endgroup
    \clearpage
    \setcounter{page}{1}
    \ATListCreate{apresentação-institucional}  % salva memória
}

